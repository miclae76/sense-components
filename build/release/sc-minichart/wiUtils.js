/*global define,document*/
define(["jquery","underscore"],function($,_){"use strict";String.prototype.replaceWith=function(f,t){var regExp=new RegExp(f,"g");return this.replace(regExp,t)},String.prototype.indexOfNth=function(substring,n){for(var times=0,index=null;times<n&&index!==-1;)index=this.indexOf(substring,index+1),times++;return index},Date.prototype.yyyymmdd=function(){var yyyy=this.getFullYear().toString(),mm=(this.getMonth()+1).toString(),dd=this.getDate().toString();return yyyy+(mm[1]?mm:"0"+mm[0])+(dd[1]?dd:"0"+dd[0])};var wiUtils={isBlank:function(obj){return!obj||""===$.trim(obj)},hasAngularBindings:function(obj){var hasBindings=!1,re=/\{{[^}]*}}/gim;return hasBindings=(obj.match(re)||[]).length>0},noScript:function(s){var div=document.createElement("div");div.innerHTML=s;for(var scripts=div.getElementsByTagName("script"),i=scripts.length;i--;)scripts[i].parentNode.removeChild(scripts[i]);return s=div.innerHTML},fnFromString:function(str){return _.isEmpty(str)?str:str.substr(0,str.indexOf("(")>-1?str.indexOf("("):void 0)},extractParams:function(str){var paramsPlus=str.match(/\((.*?)\)/g);if("object"==typeof paramsPlus&&null!==paramsPlus){var innerParam=paramsPlus[0];return _.isEmpty(innerParam)||(innerParam=innerParam.trim(),innerParam=innerParam.substr(1,innerParam.length-2)),innerParam}return null},addStyleToHeader:function(id,css){var idPattern="qwidget_"+id,$headStyle=$("#"+idPattern);0===$headStyle.length&&($headStyle=$(document.createElement("style")),$headStyle.attr("type","text/css"),$headStyle.attr("id",idPattern),$("head").append($headStyle)),$headStyle.text(css)},addStyleLinkToHeader:function(key,link){$(document).ready(function(){var idPattern="wiStyleLinked_"+key;if(0===$("#"+idPattern).length){var $lnk=$(document.createElement("link"));$lnk.attr("rel","stylesheet"),$lnk.attr("href",link),$lnk.attr("id",idPattern),$("head").append($lnk)}})},encode:function(str){return encodeURIComponent(str).replace(/'/g,"%27")},encodeForEngine:function(str){str=wiUtils.noScript(str);var t=wiUtils.encode(str);return wiUtils.isBlank(t)?t:"'"+t+"'"},decode:function(str){return decodeURIComponent(str)},decodeFromEngine:function(str){return void 0!==str&&str.length>0&&(str=wiUtils.decode(str),void 0!==str&&("'"===str.charAt(0)&&(str=str.substr(1)),"'"===str.charAt(str.length-1)&&(str=str.substr(0,str.length-1)))),str},sanitizedFileName:function(s){return s.replace(/[^a-z0-9_\-]/gi,"_")},
// Todo: (C) - Still used?
prepForEngine:function(str){return wiUtils.isBlank(str)||("'"!==str.charAt(0)&&(str="'"+str),"'"!==str.charAt(str.length-1)&&(str+="'")),str},
// Todo: (C) -  Remove completely, still used?
stringFromEngine:function(value){return void 0!==value&&value.length>0&&(value=unescape(value),void 0!==value&&("'"==value.charAt(0)&&(value=value.substr(1)),"'"==value.charAt(value.length-1)&&(value=value.substr(0,value.length-1)))),value},
// Todo: (C) - Still used?
removeStyles:function(id){$("style[qwidget-type='normal']").remove()},resizeEditors:function(baseCtrlSelector){var animationDuration=500,cHeader=140,availHeight=$(baseCtrlSelector).height()-cHeader,heightHtml=parseInt(availHeight/5*3),heightLess=availHeight-heightHtml;$("#qWidget_WidgetEditor_HtmlEditor .ace-editor").animate({"min-height":heightHtml+"px"},animationDuration),$("#qWidget_WidgetEditor_LessEditor .ace-editor").animate({"min-height":heightLess+"px"},animationDuration)}};return wiUtils});