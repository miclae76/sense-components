/**
 * Slider component
 *
 * @todo rtl not fully tested
 * @todo Default settings for rtl-support
 * @todo Some refactoring to clean some code and get rid of some duplicated code
 */
define(["angular","qlik","text!./sc-slider.ng.html","./variable-utils","./external/loglevel/loglevel.min","./external/nouislider/nouislider.min","./external/wnumb/wNumb","css!./external/nouislider/nouislider.min.css","css!./sc-slider.css"],function(angular,qlik,ngTemplate,varUtils,loglevel,noUiSlider,wNumb){"use strict";var $injector=angular.injector(["ng"]),$q=($injector.get("$timeout"),$injector.get("$q")),app=null;return{name:"scSlider",restrict:"E",replace:!0,template:ngTemplate,scope:{type:"@",min:"@",max:"@",start:"@",startLower:"@",startUpper:"@",step:"=",qsVar:"@",qsVarLower:"@",qsVarUpper:"@",orientation:"@",direction:"@",tooltips:"=",hideLabel:"=",initFromQs:"@",debugLevel:"@"},controller:function($scope){$scope.initValues=function(){$scope.min=$scope.min?$scope.min:0,$scope.max=$scope.max?$scope.max:100,$scope.start=$scope.start?$scope.start:Math.ceil($scope.max/2),$scope.startLower=$scope.startLower?$scope.startLower:$scope.min,$scope.startUpper=$scope.startUpper?$scope.startUpper:$scope.max,$scope._type=["range","single"].indexOf($scope.type)>=0?$scope.type:"single",$scope._orientation=["horizontal","vertical"].indexOf($scope.orientation)>-1?$scope.orientation:"horizontal"},$scope.initValues()},link:function(scope,element,attrs){function initSlider(config){if(sliderRequirementsCheck(config)){var sliderElem=element.find(".sc-slider-item")[0];sliderElem.noUiSlider&&(sliderElem.noUiSlider.off(),sliderElem.noUiSlider.destroy()),sliderInstance=noUiSlider.create(sliderElem,config),sliderInstance.on("change",slider_ChangeHandler),sliderInstance.on("update",slider_UpdateHandler),slider_OnInit()}}function slider_OnInit(){initSliderValues().then(function(result){}).catch(function(err){})}function slider_ChangeHandler(values,handle){ensureApp().then(varUtils.updateEngineVars.bind(null,app,getVarDefs())).catch(function(err){})}function slider_UpdateHandler(values,handle){setLabel(values)}function ensureApp(){return ensureApp()}function initSliderValues(){var defer=$q.defer(),varDefs=getVarDefs();return opts.initFromQs?varUtils.getEngineVarListValues(app,varDefs.map(function(v){return v.name})).then(function(reply){reply.result&&("single"===opts.type?scope.start=Math.ceil(reply[0].result.layout.qNum):(scope.startLower=Math.ceil(reply[0].result.layout.qNum),scope.startUpper=Math.ceil(reply[1].result.layout.qNum)))}).catch(function(err){}):defer.resolve(),defer.promise}function initLocalOpts(){opts={type:scope._type,min:angular.isDefined(scope.min)?scope.min:0,max:angular.isDefined(scope.max)?scope.max:100,step:scope.step&&_.isNumber(scope.step)?parseFloat(scope.step):1,startLower:"single"===scope._type?scope.start:scope.startLower,startUpper:scope.startUpper,qsVarLower:"single"===scope._type?scope.qsVar:scope.qsVarLower,qsVarUpper:scope.qsVarUpper,orientation:scope._orientation,direction:["ltr","rtl"].indexOf(scope.direction)>-1?scope.direction:"ltr",tooltips:scope.tooltips,initFromQs:!0}}function sliderRequirementsCheck(config){return!!config.start}function getSliderConfig(){return{start:getSliderConfig_start(),connect:"range"===scope._type,range:{min:parseInt(opts.min),max:parseInt(opts.max)},orientation:opts.orientation,format:wNumb({decimals:0}),step:opts.step,tooltips:opts.tooltips}}function getSliderConfig_start(){return"range"===scope._type?[parseInt(opts.startLower),parseInt(opts.startUpper)]:[parseInt(opts.startLower)]}function getVarDefs(values){values||(values=sliderInstance.get());var d=[];return d.push({name:opts.qsVarLower,value:values[0]}),"range"===opts.type&&d.push({name:opts.qsVarUpper,value:values[1]}),d}function setLabel(values){var labelValue="";values&&!scope.hideLabel&&(labelValue=values[0],"range"===scope._type&&(labelValue+=" - "+values[1]),element.find(".sc-slider-label")[0].innerHTML=labelValue)}function ensureApp(){var defer=$q.defer();return app||(app=qlik.currApp()),defer.resolve(app),defer.promise}ensureApp();var opts=null,sliderInstance=null;initLocalOpts(),scope.$watchGroup(["type","min","max","start","startLower","startUpper","step","qsVar","qsVarLower","qsVarUpper","orientation","direction","tooltips","hideLabel","initFromQs"],function(newVal,oldVal){scope.initValues(),initLocalOpts(),initSlider(getSliderConfig())}),scope.$watch("logLevel",function(newVal,oldVal){newVal&&newVal!==oldVal&&["off","error","warn","info","log"].indexOf(scope.debugLevel)>-1}),scope.$on("$destroy",function(){sliderInstance&&(sliderInstance.off(),sliderInstance.destroy())})}}});